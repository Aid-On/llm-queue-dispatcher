(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();class I{constructor(e){this.config=e,this.used={rpm:0,tpm:0},this.lastReset=Date.now()}canProcess(e){this.resetIfNeeded();const t=this.used.rpm<this.config.rpm,n=this.used.tpm+e<=this.config.tpm;return t?n?{allowed:!0,availableTokens:{rpm:this.config.rpm-this.used.rpm,tpm:this.config.tpm-this.used.tpm}}:{allowed:!1,reason:"tpm_limit",availableTokens:{rpm:this.config.rpm-this.used.rpm,tpm:this.config.tpm-this.used.tpm}}:{allowed:!1,reason:"rpm_limit",availableTokens:{rpm:this.config.rpm-this.used.rpm,tpm:this.config.tpm-this.used.tpm}}}consume(e){return this.resetIfNeeded(),this.used.rpm+=1,this.used.tpm+=e,!0}getMetrics(){return this.resetIfNeeded(),{rpm:{used:this.used.rpm,available:this.config.rpm-this.used.rpm,limit:this.config.rpm,percentage:this.used.rpm/this.config.rpm*100},tpm:{used:this.used.tpm,available:this.config.tpm-this.used.tpm,limit:this.config.tpm,percentage:this.used.tpm/this.config.tpm*100},efficiency:.85,consumptionHistory:{count:0,averageTokensPerRequest:0,totalTokens:0,estimationAccuracy:1},memory:{historyRecords:0,estimatedMemoryUsage:0,maxHistoryRecords:1e3},compensation:{totalDebt:0,pendingCompensation:0}}}resetIfNeeded(){const e=Date.now();e-this.lastReset>=6e4&&(this.used={rpm:0,tpm:0},this.lastReset=e)}}class L{constructor(e={}){this.config=e,this.messages=[],this.processing=[],this.completed=[],this.messageCounter=0,this.isAutoProcessing=!1,this.metrics={totalMessages:0,completedCount:0,startTime:Date.now()}}async enqueue(e){const t={id:`msg-${++this.messageCounter}`,payload:e,attributes:{enqueuedAt:new Date,receiveCount:0},score:null};return this.messages.push(t),this.metrics.totalMessages++,r("info",`Enqueued message ${t.id} with priority ${this.getPriorityName(e.priority)}`),t}async dequeue(e){if(this.messages.length===0)return null;for(const t of this.messages)t.score=this.calculateScore(t,e);this.messages.sort((t,n)=>n.score.total-t.score.total);for(let t=0;t<this.messages.length;t++){const n=this.messages[t];if(e.canProcess(n.payload.tokenInfo.estimated).allowed)return this.messages.splice(t,1),this.processing.push(n),e.consume(n.payload.tokenInfo.estimated),{message:n,markAsProcessed:async()=>{const o=this.processing.findIndex(a=>a.id===n.id);o!==-1&&(this.processing.splice(o,1),this.completed.push({...n,completedAt:new Date}),this.metrics.completedCount++,r("info",`Message ${n.id} processed successfully`))},markAsFailed:async o=>{const a=this.processing.findIndex(g=>g.id===n.id);a!==-1&&(this.processing.splice(a,1),n.attributes.receiveCount++,this.messages.push(n),r("error",`Message ${n.id} failed: ${o.message}`))}}}return null}calculateScore(e,t){const n=t.getMetrics(),o=Date.now()-e.attributes.enqueuedAt.getTime(),a=this.calculatePriorityScore(e.payload.priority),g=Math.min(o/6e4,1),h=e.payload.tokenInfo.estimated,p=n.tpm.available,T=p>0?Math.min(h/(p*.8),1):0,w=Math.max(.1,Math.pow(.7,e.attributes.receiveCount)),B=p>0&&h<=p?1:0,m=this.getWeights(),y={priority:a*m.priority,waitTime:g*m.waitTime,efficiency:T*m.efficiency,retry:w*m.retry,tokenFit:B*m.tokenFit,processingTime:.5*m.processingTime};return{total:Object.values(y).reduce((b,k)=>b+k,0),breakdown:y}}calculatePriorityScore(e){return[1,.7,.4,.1][e]||.1}getWeights(){switch(document.getElementById("queueType").value){case"simple":return{priority:.8,waitTime:.1,efficiency:.05,retry:.05,tokenFit:0,processingTime:0};case"throughput":return{priority:.15,waitTime:.1,efficiency:.35,retry:.05,tokenFit:.25,processingTime:.1};case"fair":return{priority:.2,waitTime:.5,efficiency:.1,retry:.15,tokenFit:.05,processingTime:0};default:return{priority:.25,waitTime:.2,efficiency:.2,retry:.1,tokenFit:.15,processingTime:.1}}}getPriorityName(e){return["URGENT","HIGH","NORMAL","LOW"][e]||"UNKNOWN"}async getQueueMetrics(){const t=(Date.now()-this.metrics.startTime)/1e3/60,n=t>0?this.metrics.completedCount/t:0;return{queue:{totalMessages:this.messages.length,approximateNumberOfMessages:this.messages.length,approximateNumberOfMessagesInFlight:this.processing.length},processing:{activeRequests:this.processing.length},performance:{throughput:Math.round(n*10)/10,bufferUtilization:this.messages.length/50,averageWaitTime:this.calculateAverageWaitTime()}}}calculateAverageWaitTime(){if(this.completed.length===0)return 0;const e=this.completed.reduce((t,n)=>t+(n.completedAt.getTime()-n.attributes.enqueuedAt.getTime()),0);return Math.round(e/this.completed.length)}purge(){this.messages=[],this.processing=[],this.completed=[],this.metrics={totalMessages:0,completedCount:0,startTime:Date.now()},r("info","Queue purged")}}let c,l,u;document.addEventListener("DOMContentLoaded",()=>{$(),P(),R()});function $(){l=new I({rpm:parseInt(document.getElementById("rpm").value),tpm:parseInt(document.getElementById("tpm").value)}),c=new L({bufferSize:parseInt(document.getElementById("bufferSize").value),enablePrefetch:document.getElementById("enablePrefetch").checked}),r("info","Demo initialized with in-memory queue and rate limiter")}function P(){const s=document.getElementById("bufferSize"),e=document.getElementById("bufferSizeValue");s.addEventListener("input",t=>{e.textContent=t.target.value}),document.getElementById("rpm").addEventListener("change",v),document.getElementById("tpm").addEventListener("change",v),document.getElementById("queueType").addEventListener("change",()=>{r("info",`Queue type changed to: ${document.getElementById("queueType").value}`)}),document.getElementById("addMessage").addEventListener("click",C),document.getElementById("addBatch").addEventListener("click",q),document.getElementById("processNext").addEventListener("click",E),document.getElementById("autoProcess").addEventListener("click",x),document.getElementById("pauseProcess").addEventListener("click",M),document.getElementById("clearQueue").addEventListener("click",A),document.getElementById("clearLog").addEventListener("click",H)}function v(){const s=parseInt(document.getElementById("rpm").value),e=parseInt(document.getElementById("tpm").value);l=new I({rpm:s,tpm:e}),r("info",`Rate limiter updated: ${s} RPM, ${e} TPM`)}async function C(){const s=document.getElementById("messageText").value.trim(),e=parseInt(document.getElementById("priority").value),t=parseInt(document.getElementById("estimatedTokens").value);if(!s){r("warn","Message text is required");return}const n={id:`req-${Date.now()}`,payload:{prompt:s},priority:e,tokenInfo:{estimated:t},createdAt:new Date};await c.enqueue(n),document.getElementById("messageText").value="",document.getElementById("estimatedTokens").value="100",d()}async function q(){const s=[0,1,2,2,3],e=["Analyze this data for trends","Generate a summary report","Translate this text to Spanish","Write a brief explanation","Review and provide feedback"];for(let t=0;t<5;t++){const n={id:`batch-req-${Date.now()}-${t}`,payload:{prompt:e[t]},priority:s[t],tokenInfo:{estimated:50+Math.floor(Math.random()*200)},createdAt:new Date};await c.enqueue(n)}r("info","Added batch of 5 messages"),d()}async function E(){const s=await c.dequeue(l);if(!s){r("warn","No messages available for processing"),d();return}const e=s.message;r("info",`Processing message ${e.id}...`),setTimeout(async()=>{try{if(Math.random()<.1)throw new Error("Simulated processing error");await s.markAsProcessed(),d()}catch(t){await s.markAsFailed(t),d()}},1e3+Math.random()*2e3),d()}function x(){u||(u=setInterval(E,2e3),r("info","Auto-processing started"),document.getElementById("autoProcess").disabled=!0,document.getElementById("pauseProcess").disabled=!1)}function M(){u&&(clearInterval(u),u=null,r("info","Auto-processing paused")),document.getElementById("autoProcess").disabled=!1,document.getElementById("pauseProcess").disabled=!0}function A(){M(),c.purge(),d()}function d(){N(),D(),O()}function N(){const s=document.getElementById("pendingMessages");s.innerHTML="",c.messages.forEach(i=>{const o=f(i);s.appendChild(o)});const e=document.getElementById("processingMessages");e.innerHTML="",c.processing.forEach(i=>{const o=f(i,!0);e.appendChild(o)});const t=document.getElementById("completedMessages");t.innerHTML="",c.completed.slice(-10).reverse().forEach(i=>{const o=f(i);t.appendChild(o)})}function f(s,e=!1){const t=document.createElement("div");t.className=`message-item priority-${s.payload.priority}${e?" processing-animation":""}`,t.onclick=()=>S(s);const n=["ðŸ”´ URGENT","ðŸŸ¡ HIGH","ðŸŸ¢ NORMAL","ðŸ”µ LOW"];return t.innerHTML=`
        <div class="message-header">
            <span class="message-id">${s.id}</span>
            <span class="message-priority">${n[s.payload.priority]}</span>
        </div>
        <div class="message-content">${s.payload.payload.prompt}</div>
        <div class="message-tokens">${s.payload.tokenInfo.estimated} tokens</div>
        ${s.score?`<div class="message-tokens">Score: ${s.score.total.toFixed(3)}</div>`:""}
    `,t}function S(s){const e=document.getElementById("scoringDetails");if(!s.score){e.innerHTML="<p>No scoring information available for this message</p>";return}const{total:t,breakdown:n}=s.score;e.innerHTML=`
        <h3>Scoring for ${s.id}</h3>
        <p><strong>Total Score:</strong> ${t.toFixed(3)}</p>
        <div class="score-breakdown">
            ${Object.entries(n).map(([i,o])=>`
                <div class="score-item">
                    <div class="score-name">${i.charAt(0).toUpperCase()+i.slice(1)}</div>
                    <div class="score-value">${o.toFixed(3)}</div>
                </div>
            `).join("")}
        </div>
    `}async function D(){const s=await c.getQueueMetrics(),e=l.getMetrics();document.getElementById("totalMessages").textContent=s.queue.totalMessages,document.getElementById("activeRequests").textContent=s.processing.activeRequests,document.getElementById("throughput").textContent=s.performance.throughput,document.getElementById("bufferUtilization").textContent=`${Math.round(s.performance.bufferUtilization*100)}%`,document.getElementById("avgWaitTime").textContent=`${s.performance.averageWaitTime}ms`,document.getElementById("efficiency").textContent=`${Math.round(e.efficiency*100)}%`}function O(){const s=l.getMetrics(),e=document.getElementById("rpmMeter"),t=document.getElementById("tpmMeter");e.style.setProperty("--usage",`${s.rpm.percentage}%`),t.style.setProperty("--usage",`${s.tpm.percentage}%`)}function R(){setInterval(d,1e3)}function r(s,e){const t=document.getElementById("logOutput"),n=new Date().toLocaleTimeString(),i=document.createElement("div");for(i.className="log-entry",i.innerHTML=`
        <span class="log-timestamp">${n}</span>
        <span class="log-level ${s}">${s.toUpperCase()}</span>
        ${e}
    `,t.appendChild(i),document.getElementById("autoScroll").checked&&(t.scrollTop=t.scrollHeight);t.children.length>100;)t.removeChild(t.firstChild)}function H(){document.getElementById("logOutput").innerHTML=""}
